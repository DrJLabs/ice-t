name: "🛠 CI Nightly Maintenance"

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  PYTHONUNBUFFERED: 1
  CI: true

jobs:
  check-runners:
    runs-on: [self-hosted, linux]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: "🔍 Check runner status"
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/monitoring/check_ci_status.sh > status.log
          if grep -q "❌" status.log; then
            exit 1
          fi
      - name: "📤 Upload status log"
        uses: actions/upload-artifact@v4
        with:
          name: ci-runner-status
          path: status.log
      - name: "🚨 Open issue if offline"
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Self-hosted runner offline',
              body: 'The nightly CI runner status check detected an offline runner. Please investigate.'
            });

