name: ðŸ¤– Auto-Merge Pull Requests

on:
  pull_request:
    types: [opened, ready_for_review, synchronize, reopened]
    branches: [main, develop]
  pull_request_review:
    types: [submitted, dismissed]
  check_suite:
    types: [completed]

env:
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONUNBUFFERED: 1

# Ensure only one auto-merge workflow runs at a time per PR
concurrency:
  group: auto-merge-${{ github.event.pull_request.number || github.event.check_suite.pull_requests[0].number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  # Determine if auto-merge should be enabled
  evaluate-auto-merge:
    name: ðŸ” Evaluate Auto-Merge Eligibility
    runs-on: [self-hosted, linux]
    if: |
      github.event.pull_request.draft == false &&
      github.event.pull_request.state == 'open' &&
      !github.event.pull_request.locked
    outputs:
      should-auto-merge: ${{ steps.evaluate.outputs.should-auto-merge }}
      pr-number: ${{ steps.evaluate.outputs.pr-number }}
      pr-node-id: ${{ steps.evaluate.outputs.pr-node-id }}
      merge-method: ${{ steps.evaluate.outputs.merge-method }}
      reason: ${{ steps.evaluate.outputs.reason }}
    steps:
      - name: âš¡ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ” Evaluate PR for auto-merge
        id: evaluate
        env:
          GH_TOKEN: ${{ github.token }}
        run: python scripts/evaluate_auto_merge.py

  # Enable auto-merge using GraphQL API (primary method)
  enable-auto-merge-graphql:
    name: ðŸš€ Enable Auto-Merge (GraphQL)
    runs-on: [self-hosted, linux]
    needs: evaluate-auto-merge
    if: needs.evaluate-auto-merge.outputs.should-auto-merge == 'true'
    steps:
      - name: ðŸ¤– Enable auto-merge via GraphQL
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NODE_ID: ${{ needs.evaluate-auto-merge.outputs.pr-node-id }}
          MERGE_METHOD: ${{ needs.evaluate-auto-merge.outputs.merge-method }}
        run: |
          echo "ðŸš€ Enabling auto-merge for PR #${{ needs.evaluate-auto-merge.outputs.pr-number }}"
          echo "ðŸ“¦ Merge method: $MERGE_METHOD"

          # Enable auto-merge using GraphQL API
          RESULT=$(gh api graphql -F prId="$PR_NODE_ID" -F mergeMethod="$MERGE_METHOD" -f query='
            mutation($prId: ID!, $mergeMethod: PullRequestMergeMethod!) {
              enablePullRequestAutoMerge(input: {
                pullRequestId: $prId
                mergeMethod: $mergeMethod
              }) {
                pullRequest {
                  number
                  autoMergeRequest {
                    enabledAt
                    enabledBy {
                      login
                    }
                    mergeMethod
                  }
                }
              }
            }
          ')

          if echo "$RESULT" | jq -e '.data.enablePullRequestAutoMerge.pullRequest.autoMergeRequest' >/dev/null; then
            echo "âœ… Auto-merge enabled successfully via GraphQL"
            ENABLED_AT=$(echo "$RESULT" | jq -r '.data.enablePullRequestAutoMerge.pullRequest.autoMergeRequest.enabledAt')
            echo "â° Enabled at: $ENABLED_AT"

            # Add success comment to PR
            gh pr comment ${{ needs.evaluate-auto-merge.outputs.pr-number }} --body \
              "ðŸ¤– **Auto-merge enabled** via GraphQL API

              - **Merge method**: $MERGE_METHOD
              - **Enabled at**: $ENABLED_AT
              - **Reason**: ${{ needs.evaluate-auto-merge.outputs.reason }}

              The PR will automatically merge when all required checks pass. âœ…"
          else
            echo "âŒ Failed to enable auto-merge via GraphQL"
            echo "Response: $RESULT"
            exit 1
          fi

  # Fallback: Enable auto-merge using marketplace action
  enable-auto-merge-action:
    name: ðŸ”„ Enable Auto-Merge (Action Fallback)
    runs-on: [self-hosted, linux]
    needs: [evaluate-auto-merge, enable-auto-merge-graphql]
    if: |
      needs.evaluate-auto-merge.outputs.should-auto-merge == 'true' &&
      failure()
    steps:
      - name: ðŸ”„ Enable auto-merge via marketplace action
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ github.token }}
          pull-request-number: ${{ needs.evaluate-auto-merge.outputs.pr-number }}
          merge-method: ${{ needs.evaluate-auto-merge.outputs.merge-method == 'SQUASH' && 'squash' || 'merge' }}

      - name: ðŸ“ Add fallback success comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ needs.evaluate-auto-merge.outputs.pr-number }} --body \
            "ðŸ¤– **Auto-merge enabled** via marketplace action (fallback)

            - **Merge method**: ${{ needs.evaluate-auto-merge.outputs.merge-method }}
            - **Reason**: ${{ needs.evaluate-auto-merge.outputs.reason }}

            The PR will automatically merge when all required checks pass. âœ…"

  # Auto-approve PRs from trusted sources (optional)
  auto-approve:
    name: âœ… Auto-Approve Trusted PRs
    runs-on: [self-hosted, linux]
    needs: evaluate-auto-merge
    if: |
      needs.evaluate-auto-merge.outputs.should-auto-merge == 'true' &&
      (contains(github.event.pull_request.head.ref, 'dependabot/') ||
       contains(github.event.pull_request.head.ref, 'cursor/') ||
       contains(github.event.pull_request.head.ref, 'codex/'))
    continue-on-error: true  # Don't fail the entire workflow if approval fails
    steps:
      - name: âœ… Auto-approve trusted PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if PR requires review and hasn't been approved yet
          REVIEW_STATUS=$(gh pr view ${{ needs.evaluate-auto-merge.outputs.pr-number }} --json reviewDecision --jq '.reviewDecision // "NONE"')

          if [[ "$REVIEW_STATUS" != "APPROVED" ]]; then
            echo "âœ… Attempting to auto-approve trusted PR #${{ needs.evaluate-auto-merge.outputs.pr-number }}"

            # Try to approve the PR, but handle permission errors gracefully
            if gh pr review ${{ needs.evaluate-auto-merge.outputs.pr-number }} --approve --body \
              "ðŸ¤– **Automated approval** for trusted source

              This PR is from a trusted source and has been automatically approved.
              Auto-merge will proceed once all status checks pass." 2>/dev/null; then
              echo "âœ… PR successfully auto-approved"
            else
              echo "âš ï¸ Could not auto-approve PR (likely permissions issue)"
              echo "ðŸ’¡ To enable auto-approval:"
              echo "   1. Go to Settings > Actions > General"
              echo "   2. Enable: 'Allow GitHub Actions to create and approve pull requests'"
              echo "   3. Auto-merge will still work, but manual approval may be required"

              # Add informational comment instead of approval
              gh pr comment ${{ needs.evaluate-auto-merge.outputs.pr-number }} --body \
                "ðŸ¤– **Auto-merge enabled** for trusted source

                âš ï¸ Could not auto-approve due to permissions, but auto-merge is enabled.

                **To enable auto-approval**: Go to Settings > Actions > General and enable 'Allow GitHub Actions to create and approve pull requests'

                The PR will automatically merge when all required checks pass and approvals are met. âœ…" || true
            fi
          else
            echo "âœ… PR already approved, skipping auto-approval"
          fi

  # Monitor and report auto-merge status
  monitor-auto-merge:
    name: ðŸ“Š Monitor Auto-Merge Status
    runs-on: [self-hosted, linux]
    needs: evaluate-auto-merge
    if: always()
    steps:
      - name: ðŸ“Š Generate auto-merge summary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## ðŸ¤– Auto-Merge Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.evaluate-auto-merge.outputs.pr-number }}" != "" ]; then
            echo "**PR Number**: #${{ needs.evaluate-auto-merge.outputs.pr-number }}" >> $GITHUB_STEP_SUMMARY
            echo "**Decision**: ${{ needs.evaluate-auto-merge.outputs.should-auto-merge == 'true' && 'âœ… Auto-merge enabled' || 'âŒ Auto-merge not enabled' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Reason**: ${{ needs.evaluate-auto-merge.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            echo "**Merge Method**: ${{ needs.evaluate-auto-merge.outputs.merge-method }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Decision**: âŒ No eligible PR found" >> $GITHUB_STEP_SUMMARY
            echo "**Reason**: ${{ needs.evaluate-auto-merge.outputs.reason || 'Event not related to PR or PR not found' }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Auto-Merge Criteria" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Target branch: main or develop" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PR from: dependabot, cursor/*, codex/*, or has 'auto-merge' label" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PR is mergeable and not draft" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Main branch PRs require review approval" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All required status checks must pass" >> $GITHUB_STEP_SUMMARY
