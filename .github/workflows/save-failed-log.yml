---
name: save-failed-log
"on":
  workflow_run:
    workflows: ["🚀 Turbo CI - ice-t Persistent Runners"]
    types: [completed]

jobs:
  persist:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: 📥 Fetch failing log
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p .codex/logs
          gh run view ${{ github.event.workflow_run.id }} --log \
            > .codex/logs/ci_${{ github.event.workflow_run.id }}.log

      - name: 📝 Commit log for Codex
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "ice-t-bot"
          git config user.email "ice-t-bot@users.noreply.github.com"
          git add -f .codex/logs
          git commit --no-verify -m \
            "ci(log): add failed run ${{ github.event.workflow_run.id }}"
          git push
