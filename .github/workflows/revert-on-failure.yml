name: "🔄 Auto-Revert on Main Failure"

on:
  workflow_run:
    workflows: ["🚀 Turbo CI - ice-t Persistent Runners"]
    types: [completed]
    branches: [main]

env:
  PYTHONUNBUFFERED: 1
  CI: true


defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}

jobs:
  revert-on-failure:
    name: "🔄 Revert Failed Main Commit"
    runs-on: [self-hosted, ice-t, build]
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main' }}
    timeout-minutes: 5
    steps:
      - name: "⚡ Checkout"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: "🔄 Create revert pull request"
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          FAILED_SHA="${{ github.event.workflow_run.head_sha }}"
          BRANCH="revert-${FAILED_SHA}"

          # Git identity
          git config user.name "ice-t-bot"
          git config user.email "ice-t-bot@users.noreply.github.com"

          # Revert commit on a new branch
          git switch -c "$BRANCH"
          git revert --no-edit "$FAILED_SHA" \
            || { echo "❌ Failed to create revert commit"; exit 1; }

          # Push and open PR (auto-merge label optional)
          git push --set-upstream origin "$BRANCH"
          gh pr create \
            --title "Revert $FAILED_SHA due to CI failure" \
            --body "Automatically reverting commit $FAILED_SHA which failed in [workflow run](${{ github.event.workflow_run.html_url }})." \
            --base main \
            --head "$BRANCH" \
            --label "auto-merge"

          echo "✅ Opened revert PR for commit $FAILED_SHA"

      - name: "📝 Create issue for failed commit"
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const failedSha = '${{ github.event.workflow_run.head_sha }}';
            const workflowUrl = '${{ github.event.workflow_run.html_url }}';
            await github.rest.issues.create({
              owner,
              repo,
              title: `🔄 Auto-reverted failed commit ${failedSha.substring(0, 7)}`,
              body: `## Auto-Revert Notification\n\nA commit to the main branch failed CI and has been automatically reverted.\n\n**Failed Commit**: ${failedSha}\n**Workflow Run**: ${workflowUrl}\n\nPlease review the failure and create a new PR with the fix.\n\n/cc @DrJLabs`,
              labels: ['auto-revert', 'ci-failure']
            }); 