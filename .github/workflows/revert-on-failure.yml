name: 🔄 Auto-Revert on Main Failure

on:
  workflow_run:
    workflows: ["🚀 Turbo CI - ice-t Persistent Runners"]
    types: [completed]
    branches: [main]

jobs:
  revert-on-failure:
    name: 🔄 Revert Failed Main Commit
    runs-on: [self-hosted, ice-t, build]
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main' }}
    timeout-minutes: 5
    
    steps:
      - name: ⚡ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 🔄 Create revert commit
        run: |
          # Get the failed commit SHA
          FAILED_SHA="${{ github.event.workflow_run.head_sha }}"
          
          # Configure git
          git config user.name "ice-t-bot"
          git config user.email "ice-t-bot@users.noreply.github.com"
          
          # Create revert commit
          git revert --no-edit "$FAILED_SHA" || {
            echo "❌ Failed to create revert commit"
            exit 1
          }
          
          # Push the revert
          git push origin main
          
          echo "✅ Reverted commit $FAILED_SHA on main branch"

      - name: 📝 Create issue for failed commit
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const failedSha = '${{ github.event.workflow_run.head_sha }}';
            const workflowUrl = '${{ github.event.workflow_run.html_url }}';
            
            await github.rest.issues.create({
              owner,
              repo,
              title: `🔄 Auto-reverted failed commit ${failedSha.substring(0, 7)}`,
              body: `## Auto-Revert Notification
              
              A commit to the main branch failed CI and has been automatically reverted.
              
              **Failed Commit**: ${failedSha}
              **Workflow Run**: ${workflowUrl}
              
              Please review the failure and create a new PR with the fix.
              
              /cc @DrJLabs`,
              labels: ['auto-revert', 'ci-failure']
            }); 